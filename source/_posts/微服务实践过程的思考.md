---
title: 微服务实践过程的思考
date: 2019-07-20 22:35:14
tags:
---

### 服务下沉
#### 服务依赖问题
- 同层服务若相互调用，就存在服务依赖的问题
- 层次过多会导致rpc调用过多，代码冗余也会过多，POJO定义繁琐，对开发极不友好
- 方便对业务层面进行垂直划分

### 单服务单数据源
#### 领域模型在数据源方面的体现
- 领域模型在下沉服务和数据源层面做了清晰的划分
#### 连表操作物理隔离
- 避免开发人员的非相关业务的连表操作

### 消息队列
#### 集中式消息分发
- 所有服务的消息都经由统一的消息中间件集群分发给不同的消费者，因此对消费中间件集群的吞吐和高可用要求极高
#### 分散式消息消费
- 按服务划分不同的消费者，将消费压力分担给各个服务

### 熔断限流降级机制
#### 限流
- Dubbo原生的线程池就是极好的限流器
- 信号量限流更轻量
- 加上队列的限流器会更友好
#### 熔断
- 服务提供方应该对服务接口的性能和幂等性有明确的声明（timeout和retries应该在服务提供方声明）
- 熔断后尽可能定义好降级操作
- 熔断之后的心跳重试会瞬间给服务提供方带来压力
#### 降级
- 业务层面，可配合Hystrix类的组件定义降级操作
- 网关层面，一般用来做系统全局的降级操作和流量控制（Kong会是不错的选择）

### 网关
#### 一致性hash算法
- 可提高本地缓存命中率
- 降低本地缓存内存占用，并且占用内存和服务的集群规模成反比
#### 内部调用监控

### APM和统一日志系统（ELK）
#### APM
- 方便问题的排查
- 对接口性能监控
#### 统一日志系统
- 日志系统必须统一，即所有的服务都必须使用一套日志系统
- 除了业务日志，各个组件（如MySQL慢日志，Redis服务日志，RabbitMQ错误日志等）的监控日志都必须添加到统一日志系统中

### 分布式事务
#### 一致性需求
#### 幂等性需求