---
title: 单条大Delete语句导致MySQL主从延迟几个小时问题
date: 2019-02-17 17:23:20
tags:
- MySQL
- 主从同步
---

某日清晨，线上配送业务无法正常流转，主要反馈配送状态不同步。手机也收到MySQL主从延迟的告警，看样子是主从延迟导致数据不一致。看Graf的Mysql lagging曲线，从凌晨4点到6点多，有两次主从延迟。过去一周没有出现过延迟，但是之前出现过延迟，一般在6点左右lagging就几乎没有延迟，今天却延续到将近8点。MySQL master `show full processlist`没有大量SQL执行，cpu也ok，语句已经在master执行完成，同步SQL导致延迟，而且应该是单条或者少量SQL，否则master上应该能看到大量正在执行的SQL。此时，只能等待同步完成，如果冒然kill掉同步线程，同步食物会Rollback然后重新运行，只会导致更严重的同步延迟。

导出MySQL binlog查看，延迟开始的时候，MySQL有条Delete语句，删除了一千多万条数据，正式由于该条Delete语句导致同步延迟。

#### 优化方案
- 多线程执行同步任务
MySQL 5.6默认情况下同步任务是单线程执行，如果单条SQL语句阻塞，那么之后的binlog同步只能阻塞等待。
5.7之后，MySQL支持多线程执行同步任务，**原理是如果多个事务没有两个冲突的行，那么这些事务可以认为是可以并发同步的，前提是binlog format调成row模式。**
- 分批次执行Delete
既然大SQL执行会导致同步阻塞，那么把这个大SQL拆分成小SQL执行即可。比如以上Delete语句，就可以在SQL后面加上limit限制，或者按时间访问进行删除。